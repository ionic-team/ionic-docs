<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reorder</title>
    <link rel="stylesheet" href="../../common.css" />
    <script src="../../common.js"></script>
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@ionic/core@8.6.2-dev.11749759855.198287b7/dist/ionic/ionic.esm.js"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@ionic/core@8.6.2-dev.11749759855.198287b7/css/ionic.bundle.css"
    />

    <style>
      ion-list {
        width: 300px;
      }
    </style>
  </head>

  <body>
    <ion-app>
      <ion-content>
        <div class="container">
          <ion-list lines="full">
            <!-- The reorder gesture is disabled by default, enable it to drag and drop items -->
            <ion-reorder-group disabled="false"></ion-reorder-group>
          </ion-list>
        </div>
      </ion-content>
    </ion-app>

    <script>
      let items = ['Buy groceries', 'Call the bank', 'Finish project report', 'Book flight tickets', 'Read a book'];
      const reorderGroup = document.querySelector('ion-reorder-group');

      document.addEventListener('DOMContentLoaded', () => {
        reorderItems(items);
      });

      reorderGroup.addEventListener('ionReorderMove', ({ detail }) => {
        const from = detail.from;
        const to = detail.to;

        if (from !== to) {
          console.log('Dragged from index', from, 'to', to);
        }

        // Get all items and sort by their current id (item-1, item-2, ...)
        const itemElements = Array.from(reorderGroup.querySelectorAll('ion-item')).sort((a, b) => {
          const aNum = parseInt(a.id.replace('item-', ''), 10);
          const bNum = parseInt(b.id.replace('item-', ''), 10);
          return aNum - bNum;
        });

        // Dragging down: shift up items between from+1 and to, set dragged to to+1
        if (from < to) {
          for (let i = from; i <= to; i++) {
            const item = itemElements[i];
            const itemNum = item.querySelector('b');
            if (i === from) {
              // Dragged item
              itemNum.textContent = to + 1;
              item.id = `item-${to + 1}`;
            } else {
              // Items shift up
              itemNum.textContent = i;
              item.id = `item-${i}`;
            }
          }
          // Dragging up: shift down items between to and from-1, set dragged to to+1
        } else if (from > to) {
          for (let i = to; i <= from; i++) {
            const item = itemElements[i];
            const itemNum = item.querySelector('b');
            if (i === from) {
              // Dragged item
              itemNum.textContent = to + 1;
              item.id = `item-${to + 1}`;
            } else {
              // Items shift down
              itemNum.textContent = i + 2;
              item.id = `item-${i + 2}`;
            }
          }
        }
      });

      reorderGroup.addEventListener('ionReorderEnd', ({ detail }) => {
        // Finish the reorder and update the items data
        items = detail.complete(items);

        // Re-render the DOM to match the new order
        reorderItems(items);
      });

      function reorderItems(items) {
        reorderGroup.replaceChildren();

        let reordered = '';

        for (let i = 0; i < items.length; i++) {
          reordered += `
            <ion-item id="item-${i + 1}">
              <b slot="start">${i + 1}</b>
              <ion-label>
                ${items[i]}
              </ion-label>
              <ion-reorder slot="end"></ion-reorder>
            </ion-item>
          `;
        }

        reorderGroup.innerHTML = reordered;
      }
    </script>
  </body>
</html>
